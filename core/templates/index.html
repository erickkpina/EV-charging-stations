{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="flex text-white/100 flex-col items-center bg-black w-full h-screen relative">
        <img class="absolute inset-0 w-full h-full object-cover opacity-20" alt="Imagem de fundo"
             src={% static 'images/bg-image.jpg' %}>
        <div class="flex flex-col items-center pt-20">
            <div class="flex flex-row items-center">
                <p class="text-8xl font-bold px-3">FIND</p>


                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor"
                     class="bi bi-pin-map text-green-500" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M3.1 11.2a.5.5 0 0 1 .4-.2H6a.5.5 0 0 1 0 1H3.75L1.5 15h13l-2.25-3H10a.5.5 0 0 1 0-1h2.5a.5.5 0 0 1 .4.2l3 4a.5.5 0 0 1-.4.8H.5a.5.5 0 0 1-.4-.8l3-4z"></path>
                    <path fill-rule="evenodd"
                          d="M8 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6zM4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999z"></path>
                </svg>

            </div>
            <div class="flex flex-row items-center">
                <p class="text-8xl font-bold px-3">CHARGE</p>

                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor"
                     class="bi bi-lightning-charge text-green-500" viewBox="0 0 16 16">
                    <path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09zM4.157 8.5H7a.5.5 0 0 1 .478.647L6.11 13.59l5.732-6.09H9a.5.5 0 0 1-.478-.647L9.89 2.41 4.157 8.5z"></path>
                </svg>
            </div>
            <div class="flex flex-row items-center">
                <p class="text-8xl font-bold px-3">GO</p>

                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor"
                     class="bi bi-signpost-split text-green-500" viewBox="0 0 16 16">
                    <path d="M7 7V1.414a1 1 0 0 1 2 0V2h5a1 1 0 0 1 .8.4l.975 1.3a.5.5 0 0 1 0 .6L14.8 5.6a1 1 0 0 1-.8.4H9v10H7v-5H2a1 1 0 0 1-.8-.4L.225 9.3a.5.5 0 0 1 0-.6L1.2 7.4A1 1 0 0 1 2 7h5zm1 3V8H2l-.75 1L2 10h6zm0-5h6l.75-1L14 3H8v2z"></path>
                </svg>
            </div>
        </div>
        <div class="flex flex-row text-3xl pt-5">
            <p>Find any</p>
            <p class=" hover:text-green-400 hover:ease-in-out hover:duration-300 px-2.5">Electric</p>
            <p>Charging Station in the UK.</p>
        </div>
    </div>



    <div id="map" style="height: 100vh; width:100%;" class="relative z-0"></div>
    {{ stations|json_script:"stations_json" }}


    <script>
        var map = L.map('map').setView([54.435049, -3.505543], 5);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);


        let stations = JSON.parse(document.getElementById('stations_json').textContent)

        stations.forEach(station => {
            L.marker([station.latitude, station.longitude]).addTo(map)
        });

        map.on('click', (e) => {
            let lat = e.latlng.lat
            let longitude = e.latlng.lng
            L.marker([lat, longitude]).addTo(map);


            fetch(`/get-nearest-station?latitude=${lat}&longitude=${longitude}`)
                .then(response => response.json())
                .then(result => {
                    station_coordinates = result.coordinates
                    const roundedDistance = result.distance.toFixed(2);

                    user_coordinates = [lat, longitude]
                    L.routing.control({
                        waypoints: [
                            L.latLng(lat, longitude),
                            L.latLng(station_coordinates[0], station_coordinates[1])
                        ],
                        routeWhileDragging: true
                    }).addTo(map);

                    var popup = L.popup()
                        .setLatLng([lat, longitude])
                        .setContent(`Distance: ${roundedDistance} Km`)
                        .openOn(map);
                })

        })
    </script>

{% endblock %}